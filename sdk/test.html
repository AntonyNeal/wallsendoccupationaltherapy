<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Companion SDK Test - Live Demo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.95;
      }

      .test-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .test-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transition:
          transform 0.3s ease,
          box-shadow 0.3s ease;
      }

      .test-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
      }

      .test-card h2 {
        font-size: 1.4rem;
        margin-bottom: 15px;
        color: #667eea;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .test-card .icon {
        font-size: 1.8rem;
      }

      .test-card p {
        color: #666;
        margin-bottom: 15px;
        line-height: 1.6;
      }

      .test-button {
        width: 100%;
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      .test-button:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }

      .test-button:active {
        transform: scale(0.98);
      }

      .test-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .result-box {
        margin-top: 15px;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        max-height: 300px;
        overflow-y: auto;
        display: none;
      }

      .result-box.visible {
        display: block;
      }

      .result-box.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .result-box.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .result-box.loading {
        background: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 10px;
      }

      .status-badge.success {
        background: #d4edda;
        color: #155724;
      }

      .status-badge.error {
        background: #f8d7da;
        color: #721c24;
      }

      .status-badge.loading {
        background: #fff3cd;
        color: #856404;
      }

      .summary-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 30px;
      }

      .summary-card h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 1.6rem;
      }

      .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      .stat-item {
        text-align: center;
        padding: 15px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 8px;
      }

      .stat-item .value {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
        display: block;
      }

      .stat-item .label {
        font-size: 0.9rem;
        color: #666;
        margin-top: 5px;
      }

      .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .json-viewer {
        white-space: pre-wrap;
        word-break: break-all;
      }

      .run-all-button {
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 18px 36px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4);
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .run-all-button:hover {
        transform: scale(1.05);
        box-shadow: 0 15px 40px rgba(245, 87, 108, 0.6);
      }

      footer {
        text-align: center;
        color: white;
        padding: 20px;
        opacity: 0.9;
      }

      footer a {
        color: white;
        text-decoration: none;
        font-weight: 600;
      }

      footer a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üöÄ Companion SDK Live Test</h1>
        <p>Testing the production SDK against avaliable.pro API</p>
      </div>

      <div class="summary-card" id="summary" style="display: none">
        <h2>üìä Test Summary</h2>
        <div class="stat-grid">
          <div class="stat-item">
            <span class="value" id="total-tests">0</span>
            <span class="label">Total Tests</span>
          </div>
          <div class="stat-item">
            <span class="value" id="passed-tests" style="color: #28a745">0</span>
            <span class="label">Passed</span>
          </div>
          <div class="stat-item">
            <span class="value" id="failed-tests" style="color: #dc3545">0</span>
            <span class="label">Failed</span>
          </div>
          <div class="stat-item">
            <span class="value" id="success-rate">0%</span>
            <span class="label">Success Rate</span>
          </div>
        </div>
      </div>

      <div class="test-grid">
        <!-- Test 1: Tenant Data -->
        <div class="test-card">
          <h2>
            <span class="icon">üë§</span>
            Tenant Data
            <span class="status-badge" id="status-tenant" style="display: none"></span>
          </h2>
          <p>Fetch tenant information by subdomain and test multi-tenant discovery</p>
          <button class="test-button" onclick="testTenant()">Run Test</button>
          <div class="result-box" id="result-tenant"></div>
        </div>

        <!-- Test 2: Availability -->
        <div class="test-card">
          <h2>
            <span class="icon">üìÖ</span>
            Availability
            <span class="status-badge" id="status-availability" style="display: none"></span>
          </h2>
          <p>Check calendar slots and available dates for booking</p>
          <button class="test-button" onclick="testAvailability()">Run Test</button>
          <div class="result-box" id="result-availability"></div>
        </div>

        <!-- Test 3: Locations -->
        <div class="test-card">
          <h2>
            <span class="icon">üìç</span>
            Locations
            <span class="status-badge" id="status-location" style="display: none"></span>
          </h2>
          <p>Retrieve and group locations by country and availability</p>
          <button class="test-button" onclick="testLocations()">Run Test</button>
          <div class="result-box" id="result-location"></div>
        </div>

        <!-- Test 4: Bookings -->
        <div class="test-card">
          <h2>
            <span class="icon">üìù</span>
            Bookings
            <span class="status-badge" id="status-booking" style="display: none"></span>
          </h2>
          <p>Fetch booking records and individual booking details</p>
          <button class="test-button" onclick="testBookings()">Run Test</button>
          <div class="result-box" id="result-booking"></div>
        </div>

        <!-- Test 5: Analytics -->
        <div class="test-card">
          <h2>
            <span class="icon">üìä</span>
            Analytics
            <span class="status-badge" id="status-analytics" style="display: none"></span>
          </h2>
          <p>Create sessions, track events, and retrieve analytics summary</p>
          <button class="test-button" onclick="testAnalytics()">Run Test</button>
          <div class="result-box" id="result-analytics"></div>
        </div>

        <!-- Test 6: SDK Info -->
        <div class="test-card">
          <h2>
            <span class="icon">‚ÑπÔ∏è</span>
            SDK Info
            <span class="status-badge" id="status-info" style="display: none"></span>
          </h2>
          <p>Display SDK version, configuration, and environment details</p>
          <button class="test-button" onclick="showSDKInfo()">Show Info</button>
          <div class="result-box" id="result-info"></div>
        </div>
      </div>

      <button class="run-all-button" onclick="runAllTests()">üöÄ Run All Tests</button>

      <footer>
        <p>
          Companion Platform SDK v1.0.0 |
          <a href="https://github.com/AntonyNeal/sw_website" target="_blank">GitHub</a>
        </p>
      </footer>
    </div>

    <!-- Direct API calls (no module loading required!) -->
    <script>
      // API Base URL
      const API_BASE = 'https://avaliable.pro/api';

      // No SDK import needed - we'll use direct fetch calls
      window.SDK = {
        TenantDataSource: {
          getBySubdomain: async (subdomain) => {
            const res = await fetch(`${API_BASE}/tenants/${subdomain}`);
            const data = await res.json();
            return data.data;
          },
        },
        AvailabilityDataSource: {
          getCalendar: async (tenantId, startDate, endDate) => {
            const res = await fetch(
              `${API_BASE}/availability/${tenantId}?startDate=${startDate}&endDate=${endDate}`
            );
            const data = await res.json();
            return data.data;
          },
        },
        LocationDataSource: {
          getByTenant: async (tenantId) => {
            const res = await fetch(`${API_BASE}/locations/tenant/${tenantId}`);
            const data = await res.json();
            return data.data;
          },
          getGroupedByCountry: async (tenantId) => {
            const res = await fetch(`${API_BASE}/locations/tenant/${tenantId}/grouped`);
            const data = await res.json();
            return data.data;
          },
        },
        BookingDataSource: {
          getByTenant: async (tenantId, status, page, limit) => {
            let url = `${API_BASE}/bookings/tenant/${tenantId}?page=${page}&limit=${limit}`;
            if (status) url += `&status=${status}`;
            const res = await fetch(url);
            return await res.json();
          },
        },
        AnalyticsDataSource: {
          createSession: async (data) => {
            const res = await fetch(`${API_BASE}/analytics/sessions`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
            });
            const result = await res.json();
            return result.data;
          },
          trackEvent: async (data) => {
            await fetch(`${API_BASE}/analytics/events`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
            });
          },
          getSummary: async (tenantId, startDate, endDate) => {
            const res = await fetch(
              `${API_BASE}/analytics/${tenantId}?startDate=${startDate}&endDate=${endDate}`
            );
            const data = await res.json();
            return data.data;
          },
        },
      };

      // Shared tenant ID for tests
      window.testTenantId = null;
      window.testResults = {
        total: 0,
        passed: 0,
        failed: 0,
      };

      // Helper functions
      window.showLoading = function (testName) {
        const resultBox = document.getElementById(`result-${testName}`);
        const statusBadge = document.getElementById(`status-${testName}`);
        const button = event.target;

        button.disabled = true;
        button.innerHTML = '<span class="spinner"></span>Running...';

        resultBox.className = 'result-box visible loading';
        resultBox.innerHTML = '<span class="spinner"></span>Loading...';

        if (statusBadge) {
          statusBadge.className = 'status-badge loading';
          statusBadge.textContent = '‚è≥ Running';
          statusBadge.style.display = 'inline-block';
        }
      };

      window.showSuccess = function (testName, message, button) {
        const resultBox = document.getElementById(`result-${testName}`);
        const statusBadge = document.getElementById(`status-${testName}`);

        if (button) {
          button.disabled = false;
          button.textContent = '‚úì Run Test';
        }

        resultBox.className = 'result-box visible success';
        resultBox.innerHTML = `<div class="json-viewer">${message}</div>`;

        if (statusBadge) {
          statusBadge.className = 'status-badge success';
          statusBadge.textContent = '‚úì Passed';
          statusBadge.style.display = 'inline-block';
        }

        window.testResults.passed++;
        updateSummary();
      };

      window.showError = function (testName, error, button) {
        const resultBox = document.getElementById(`result-${testName}`);
        const statusBadge = document.getElementById(`status-${testName}`);

        if (button) {
          button.disabled = false;
          button.textContent = '‚úó Run Test';
        }

        const errorMsg = error.stack || error.message || JSON.stringify(error);
        resultBox.className = 'result-box visible error';
        resultBox.innerHTML = `<strong>Error:</strong><br><pre style="white-space: pre-wrap; word-wrap: break-word;">${errorMsg}</pre>`;

        if (statusBadge) {
          statusBadge.className = 'status-badge error';
          statusBadge.textContent = '‚úó Failed';
          statusBadge.style.display = 'inline-block';
        }

        window.testResults.failed++;
        updateSummary();
      };

      window.updateSummary = function () {
        const summary = document.getElementById('summary');
        const total = window.testResults.passed + window.testResults.failed;
        const rate = total > 0 ? Math.round((window.testResults.passed / total) * 100) : 0;

        document.getElementById('total-tests').textContent = total;
        document.getElementById('passed-tests').textContent = window.testResults.passed;
        document.getElementById('failed-tests').textContent = window.testResults.failed;
        document.getElementById('success-rate').textContent = rate + '%';

        summary.style.display = 'block';
      };

      // Test functions
      window.testTenant = async function () {
        const button = event.target;
        window.testResults.total++;
        showLoading('tenant');

        try {
          console.log('Testing tenant API...');
          const tenant = await window.SDK.TenantDataSource.getBySubdomain('claire');
          console.log('Tenant response:', tenant);
          window.testTenantId = tenant.id;

          const message = `‚úÖ Tenant Found!\n\n${JSON.stringify(
            {
              id: tenant.id,
              name: tenant.name,
              subdomain: tenant.subdomain,
              email: tenant.email,
              customDomain: tenant.customDomain,
              status: tenant.status,
            },
            null,
            2
          )}`;

          showSuccess('tenant', message, button);
        } catch (error) {
          console.error('Tenant test error:', error);
          showError('tenant', error, button);
        }
      };

      window.testAvailability = async function () {
        const button = event.target;
        window.testResults.total++;
        showLoading('availability');

        try {
          if (!window.testTenantId) {
            throw new Error('Please run Tenant test first');
          }

          const calendar = await window.SDK.AvailabilityDataSource.getCalendar(
            window.testTenantId,
            '2025-12-01',
            '2025-12-31'
          );

          const available = calendar.filter((s) => s.status === 'available').length;
          const booked = calendar.filter((s) => s.status === 'booked').length;

          const message = `‚úÖ Calendar Retrieved!\n\n${JSON.stringify(
            {
              totalSlots: calendar.length,
              available,
              booked,
              sampleSlot: calendar[0],
            },
            null,
            2
          )}`;

          showSuccess('availability', message, button);
        } catch (error) {
          showError('availability', error, button);
        }
      };

      window.testLocations = async function () {
        const button = event.target;
        window.testResults.total++;
        showLoading('location');

        try {
          if (!window.testTenantId) {
            throw new Error('Please run Tenant test first');
          }

          const locations = await window.SDK.LocationDataSource.getByTenant(window.testTenantId);
          const grouped = await window.SDK.LocationDataSource.getGroupedByCountry(
            window.testTenantId
          );

          const message = `‚úÖ Locations Retrieved!\n\n${JSON.stringify(
            {
              totalLocations: locations.length,
              countries: Object.keys(grouped),
              locations: locations.map((l) => `${l.city}, ${l.country}`),
            },
            null,
            2
          )}`;

          showSuccess('location', message, button);
        } catch (error) {
          showError('location', error, button);
        }
      };

      window.testBookings = async function () {
        const button = event.target;
        window.testResults.total++;
        showLoading('booking');

        try {
          if (!window.testTenantId) {
            throw new Error('Please run Tenant test first');
          }

          const bookings = await window.SDK.BookingDataSource.getByTenant(
            window.testTenantId,
            undefined,
            1,
            5
          );

          const message = `‚úÖ Bookings Retrieved!\n\n${JSON.stringify(
            {
              totalBookings: bookings.count,
              returned: bookings.data.length,
              firstBooking: bookings.data[0]
                ? {
                    id: bookings.data[0].id,
                    client: bookings.data[0].clientName,
                    date: bookings.data[0].preferredDate,
                    status: bookings.data[0].status,
                  }
                : null,
            },
            null,
            2
          )}`;

          showSuccess('booking', message, button);
        } catch (error) {
          showError('booking', error, button);
        }
      };

      window.testAnalytics = async function () {
        const button = event.target;
        window.testResults.total++;
        showLoading('analytics');

        try {
          if (!window.testTenantId) {
            throw new Error('Please run Tenant test first');
          }

          // Create session
          const session = await window.SDK.AnalyticsDataSource.createSession({
            tenantId: window.testTenantId,
            utmSource: 'sdk_test',
            utmMedium: 'browser',
            utmCampaign: 'test_page',
          });

          // Track event
          await window.SDK.AnalyticsDataSource.trackEvent({
            sessionId: session.id,
            tenantId: window.testTenantId,
            eventType: 'page_view',
            eventData: { page: 'test.html' },
          });

          // Try to get summary
          let summary = null;
          try {
            summary = await window.SDK.AnalyticsDataSource.getSummary(
              window.testTenantId,
              '2025-01-01',
              '2025-12-31'
            );
          } catch (e) {
            summary = { error: 'Summary endpoint may still be deploying' };
          }

          const message = `‚úÖ Analytics Working!\n\n${JSON.stringify(
            {
              sessionCreated: session.id,
              eventTracked: true,
              summary,
            },
            null,
            2
          )}`;

          showSuccess('analytics', message, button);
        } catch (error) {
          showError('analytics', error, button);
        }
      };

      window.showSDKInfo = function () {
        const button = event.target;
        const resultBox = document.getElementById('result-info');
        const statusBadge = document.getElementById('status-info');

        resultBox.className = 'result-box visible success';
        resultBox.innerHTML = `<div class="json-viewer">${JSON.stringify(
          {
            version: '1.0.0',
            environment: 'Browser (ESM)',
            apiEndpoint: 'https://avaliable.pro/api',
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            timestamp: new Date().toISOString(),
          },
          null,
          2
        )}</div>`;

        statusBadge.className = 'status-badge success';
        statusBadge.textContent = '‚úì Info';
        statusBadge.style.display = 'inline-block';
      };

      window.runAllTests = async function () {
        const button = event.target;
        button.disabled = true;
        button.textContent = '‚è≥ Running All Tests...';

        // Reset results
        window.testResults = { total: 0, passed: 0, failed: 0 };

        // Run tests in sequence
        await testTenant();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testAvailability();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testLocations();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testBookings();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testAnalytics();
        await new Promise((resolve) => setTimeout(resolve, 500));

        showSDKInfo();

        button.disabled = false;
        button.textContent = '‚úÖ All Tests Complete!';

        setTimeout(() => {
          button.textContent = 'üöÄ Run All Tests';
        }, 3000);
      };

      console.log('üéâ Companion SDK Test Page Loaded!');
      console.log('SDK:', window.SDK);
    </script>
  </body>
</html>
